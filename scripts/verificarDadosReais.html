<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificar Dados Reais - Firebase</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 32px; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 16px; }
    .status {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .status.loading { background: #e3f2fd; color: #1976d2; }
    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .collection-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    .collection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .collection-name { font-size: 20px; font-weight: 600; color: #333; }
    .collection-count {
      background: #667eea;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 600;
    }
    .examples {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .example-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      color: #555;
    }
    .example-item:last-child { border-bottom: none; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }
    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-top: 30px;
    }
    .summary h2 { margin-bottom: 20px; font-size: 24px; }
    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .summary-stat:last-child { border-bottom: none; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Verificar Dados Reais do Firebase</h1>
    <p class="subtitle">Projeto: oficina-reparofacil</p>

    <div id="status" class="status loading">‚è≥ Conectando ao Firebase...</div>

    <div>
      <button id="btnVerificar" onclick="verificarTudo()">üîÑ Verificar Todos os Dados</button>
      <button onclick="verificarUsuario()">üë§ Verificar Usu√°rio renier@reparo.com</button>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCMhYAH03gzL0H705XjSBp8-4gxhmE246Q",
      authDomain: "oficina-reparofacil.firebaseapp.com",
      projectId: "oficina-reparofacil",
      storageBucket: "oficina-reparofacil.firebasestorage.app",
      messagingSenderId: "610352587990",
      appId: "1:610352587990:web:dc0add122ccb7f54c09577",
      measurementId: "G-YGV44MV8G3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.doc = doc;
    window.getDoc = getDoc;

    document.getElementById('status').innerHTML = '‚úÖ Conectado ao Firebase!';
    document.getElementById('status').className = 'status success';
  </script>

  <script>
    async function verificarUsuario() {
      const statusDiv = document.getElementById('status');
      const resultsDiv = document.getElementById('results');

      statusDiv.className = 'status loading';
      statusDiv.innerHTML = '‚è≥ Verificando usu√°rio renier@reparo.com...';

      try {
        // Buscar usu√°rio por email
        const usuariosRef = window.collection(window.db, 'usuarios');
        const q = window.query(usuariosRef, window.where('email', '==', 'renier@reparo.com'));
        const snapshot = await window.getDocs(q);

        if (snapshot.empty) {
          statusDiv.className = 'status error';
          statusDiv.innerHTML = '‚ùå Usu√°rio renier@reparo.com n√£o encontrado!';
          return;
        }

        const userDoc = snapshot.docs[0];
        const userData = userDoc.data();

        const card = document.createElement('div');
        card.className = 'collection-card';
        card.innerHTML = `
          <div class="collection-header">
            <div class="collection-name">üë§ Usu√°rio: ${userData.email}</div>
          </div>
          <pre>${JSON.stringify(userData, null, 2)}</pre>
          <div style="margin-top: 15px;">
            <strong>empresaId:</strong> ${userData.empresaId || 'null (Super Admin sem empresa)'}
            <br><strong>role:</strong> ${userData.role || 'n√£o definido'}
          </div>
        `;
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(card);

        statusDiv.className = 'status success';
        statusDiv.innerHTML = '‚úÖ Usu√°rio encontrado!';

      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = '‚ùå Erro: ' + error.message;
        console.error(error);
      }
    }

    async function verificarTudo() {
      const btnVerificar = document.getElementById('btnVerificar');
      const statusDiv = document.getElementById('status');
      const resultsDiv = document.getElementById('results');

      btnVerificar.disabled = true;
      statusDiv.className = 'status loading';
      statusDiv.innerHTML = '‚è≥ Verificando TODOS os dados...';
      resultsDiv.innerHTML = '';

      const colecoes = [
        'clients', 'clientes',
        'checkins',
        'budgets', 'orcamentos',
        'inventory', 'estoque',
        'vehicles', 'veiculos',
        'tools', 'ferramentas',
        'usuarios',
        'empresas'
      ];

      const resultados = {};
      let totalDocs = 0;

      for (const nomeColecao of colecoes) {
        try {
          const colRef = window.collection(window.db, nomeColecao);
          const snapshot = await window.getDocs(colRef);
          const count = snapshot.size;

          if (count > 0) {
            const exemplos = [];
            snapshot.docs.slice(0, 5).forEach(doc => {
              const data = doc.data();
              exemplos.push({
                id: doc.id,
                data: data
              });
            });

            resultados[nomeColecao] = { count, exemplos };
            totalDocs += count;

            const card = document.createElement('div');
            card.className = 'collection-card';
            card.innerHTML = `
              <div class="collection-header">
                <div class="collection-name">üì¶ ${nomeColecao}</div>
                <div class="collection-count">${count} documento(s)</div>
              </div>
              <div class="examples">
                <strong>Exemplos (primeiros 5):</strong>
                ${exemplos.map(ex => `
                  <div class="example-item">
                    <strong>ID:</strong> ${ex.id}
                    <pre>${JSON.stringify(ex.data, null, 2)}</pre>
                  </div>
                `).join('')}
              </div>
            `;
            resultsDiv.appendChild(card);
          }
        } catch (error) {
          console.error(`Erro ao verificar ${nomeColecao}:`, error);
        }
      }

      // Verificar estrutura multi-tenant
      try {
        const empresasRef = window.collection(window.db, 'empresas');
        const empresasSnapshot = await window.getDocs(empresasRef);

        if (!empresasSnapshot.empty) {
          for (const empresaDoc of empresasSnapshot.docs) {
            const empresaId = empresaDoc.id;
            const empresaData = empresaDoc.data();

            const card = document.createElement('div');
            card.className = 'collection-card';
            card.style.borderLeft = '4px solid #ff6b35';
            
            let html = `
              <div class="collection-header">
                <div class="collection-name">üè¢ Empresa: ${empresaData.nomeFantasia || empresaId}</div>
              </div>
              <div class="examples">
                <strong>Dados da Empresa:</strong>
                <pre>${JSON.stringify(empresaData, null, 2)}</pre>
                <br><strong>Subcole√ß√µes:</strong>
            `;

            const subcolecoes = ['clientes', 'checkins', 'orcamentos', 'estoque', 'veiculos'];
            for (const sub of subcolecoes) {
              try {
                const subRef = window.collection(window.db, 'empresas', empresaId, sub);
                const subSnap = await window.getDocs(subRef);
                if (subSnap.size > 0) {
                  html += `<br>   ‚úÖ ${sub}: ${subSnap.size} documento(s)`;
                  totalDocs += subSnap.size;
                }
              } catch (e) {}
            }

            html += `</div>`;
            card.innerHTML = html;
            resultsDiv.appendChild(card);
          }
        }
      } catch (error) {
        console.error('Erro ao verificar empresas:', error);
      }

      // Resumo
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.innerHTML = `
        <h2>üìä Resumo</h2>
        <div class="summary-stat">
          <span>Total de documentos encontrados:</span>
          <strong>${totalDocs}</strong>
        </div>
        <div class="summary-stat">
          <span>Cole√ß√µes com dados:</span>
          <strong>${Object.keys(resultados).length}</strong>
        </div>
      `;
      resultsDiv.appendChild(summary);

      statusDiv.className = 'status success';
      statusDiv.innerHTML = `‚úÖ Verifica√ß√£o conclu√≠da! ${totalDocs} documentos encontrados.`;
      btnVerificar.disabled = false;
    }
  </script>
</body>
</html>
